# pysay

Like `cowsay` but with a `python` and written in `Python`.

From a `Real Python` tutorial.

It's a simple project that let's me focus on other things like CI, Releases,
Publishing, Pages, etc.

Once it's feature complete, I might treat it as an archived project and only
play with dependency update related maintenance.

## Usage

To show the usage help screen run: `nix run github:vpayno/pysay#usage`

```text
$ nix run github:vpayno/pysay#usage
this derivation will be built:
  /nix/store/j7y81rm34jn8v6j001z7xzlh6zq9i3d0-showUsage.drv
building '/nix/store/j7y81rm34jn8v6j001z7xzlh6zq9i3d0-showUsage.drv'...
Available pysay flake commands:

  nix run .#usage

  nix run . -- message
    nix run .#default -- message
    nix run .#pysay -- message

  nix profile install github:vpayno/pysay
```

To to run `pysay` run: `nix run github:vpayno/pysay -- "Hello World!"`

```text
$ nix run github:vpayno/pysay -- "Hello World!"

     ______________
    ( Hello World! )
     --------------
       \    __
        \  {oo}
           (__)\
             λ \\
               _\\__
              (_____)_
             (________)0o°
```

To install `pysay` from the command line use `nix profile install`.

```text
$ nix profile install github:vpayno/pysay

$ nix profile list
Name:               pysay
Flake attribute:    packages.x86_64-linux.default
Original flake URL: github:vpayno/pysay
Locked flake URL:   github:vpayno/pysay/d935615aadd005e9a8c1bf1f8e2f1dc77a6aae79?narHash=sha256-fcp2HSmibZsXsdGBcOdue3k4EKBu5l5oND5JpkOOHV8%3D
Store paths:        /nix/store/m79i1q42qmbj21yxbgi6d37frzcs6ppk-pysay-prod-env

$ which pysay
/home/vpayno/.nix-profile/bin/pysay
```

## pdm to uv

Switched from `pdm` to `uv` to make working with the project using `uv2nix`
easier.

## Development environment

Using [devbox](https://github.com/jetify-com/devbox) to manage the development
environment.

Using [runme](https://github.com/stateful/runme) to add runnable markdown
playbooks to the project.

### devbox

Before starting development, run `devbox shell` to enter the `devbox`
development environment.

The development shell manages compiler and tool installations so you don't have
to and uses the versions specified by the project so you don't have to have them
installed locally.

To start the development shell run:

```bash
devbox shell
```

To see the list of available "scripts" run:

```bash
devbox run --list
```

To run an individual command in a devbox shell run:

```bash { name=uv-02-update_locks }
devbox update_locks
```

### runme

To see the list of available plays run:

```bash
devbox run runme list
```

To run a single play type:

```bash
devbox run runme run uv-02-update_locks
```

### devbox shell

Use the `devbox shell` for development.

```bash
$ devbox shell

$ which python
/home/vpayno/git_vpayno/pysay-cr-uv/.venv/bin/python

$ which uv
/home/vpayno/git_vpayno/pysay-cr-uv/.devbox/nix/profile/default/bin/uv

$ which pysay
/home/vpayno/git_vpayno/pysay-cr-uv/.venv/bin/pysay

$ exit
```

### nix develop

To start a nix flake development shell with pysay run `nix develop`:

```bash
$ nix develop

$ which pysay
/nix/store/0256lx2lafd5vlvz8lqpks5vji0q0zjs-pysay/bin/pysay
```

### devenv shell

[devenv](https://devenv.sh/getting-started/) is another `nix` based development
environment.

To start the shell run `devenv shell`.

```bash
$ devenv shell
• Building shell ...
• Using Cachix: devenv
✔ Building shell in 51.5ms
Entering shell
warning: unknown experimental feature 'pipe-operators'
Running tasks     devenv:enterShell
Succeeded         devenv:enterShell 3ms
1 Succeeded                         4.62ms

Resolved 53 packages in 5ms
Audited 52 packages in 0.18ms

devenv for Python Project pysay

$ which python uv pysay pip
/home/vpayno/git_vpayno/pysay/.venv/bin/python
/nix/store/w7cs06nn9vvk8a59nv48y4biv9zzv43x-uv-0.4.30/bin/uv
/home/vpayno/git_vpayno/pysay/.venv/bin/pysay
/nix/store/ykq20bhiw8khiyg4nwwl6qc6i5gh9ing-pip/bin/pip

$ cat /nix/store/ykq20bhiw8khiyg4nwwl6qc6i5gh9ing-pip/bin/pip
#!/nix/store/p6k7xp1lsfmbdd731mlglrdj2d66mr82-bash-5.2p37/bin/bash
/nix/store/w7cs06nn9vvk8a59nv48y4biv9zzv43x-uv-0.4.30/bin/uv pip "$@"
```

I'm having issues with `uv.lock` incompatibilities. It's not compatible with the
`uv.lock` file generated by `devbox`.

```text
Creating virtual environment at: .venv
error: Failed to parse `uv.lock`
  Caused by: TOML parse error at line 564, column 1
    |
564 | [[package]]
    | ^^^^^^^^^^^
missing field `version`
```

The `devbox` `virtualenv` integration doesn't generate the version field in the
project.

```toml
 [[package]]
 name = "pysay"
-version = "0.5.2.dev7+gc835dc1.d19800101"
 source = { editable = "." }
```

## Running

### uv

You can use devbox shell and uv to run the main application.

```text
$ devbox run uv run pysay hello
     _______
    ( hello )
     -------
       \    __
        \  {oo}
           (__)\
             λ \\
               _\\__
              (_____)_
             (________)0o°
```

### nix run

To use `pysay` without installing it use `nix run`.

To run it from GitHub without a local git checkout:

```text
$ nix run github:vpayno/pysay -- hello

     _______
    ( hello )
     -------
       \    __
        \  {oo}
           (__)\
             λ \\
               _\\__
              (_____)_
             (________)0o°
```

To run a specific version from GitHub using a specific version use the
`?tag=v0.5.0` argument:

```text
$ nix run github:vpayno/pysay?tag=v0.5.0 -- hello

     _______
    ( hello )
     -------
       \    __
        \  {oo}
           (__)\
             λ \\
               _\\__
              (_____)_
             (________)0o°
```

To run it from a local git checkout:

```text
$ nix run . -- hello

     _______
    ( hello )
     -------
       \    __
        \  {oo}
           (__)\
             λ \\
               _\\__
              (_____)_
             (________)0o°
```

### nix-shell

To start a nix shell with `pysay` installed in it use `nix shell`.

Note: Tried using `pip2nix` but it needs the project to support Python 3.9 which
creates other problems.

```text
$ nix run github:nix-community/pip2nix generate .

$ git add python-packages.nix

$ nix-shell
these 34 derivations will be built:
  /nix/store/6s836yxxy0yfhblwbv2ini3hq12rdwjh-python3.12-setuptools-75.1.0.drv
...
  /nix/store/6akq3b0pzs85wyfwdzc369qhnl79syf0-python3-3.12.7-env.drv
building '/nix/store/6s836yxxy0yfhblwbv2ini3hq12rdwjh-python3.12-setuptools-75.1.0.drv'...
adding 'setuptools-75.1.0.post0.dist-info/RECORD'
removing build/bdist.linux-x86_64/wheel
Successfully built setuptools-75.1.0.post0-py3-none-any.whl
Finished creating a wheel...
Finished executing pypaBuildPhase
Running phase: pythonRuntimeDepsCheckHook
Executing pythonRuntimeDepsCheck
Checking runtime dependencies for setuptools-75.1.0.post0-py3-none-any.whl
  + Exception Group Traceback (most recent call last):
  |   File "/nix/store/gdxd1rn8zgjjw08ijghvpazj18n4sjl6-python-runtime-deps-check-hook.py", line 93, in <module>
  |     metadata = get_metadata(args.wheel)
  |                ^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/nix/store/gdxd1rn8zgjjw08ijghvpazj18n4sjl6-python-runtime-deps-check-hook.py", line 58, in get_metadata
  |     metadata = Metadata.from_raw(raw)
  |                ^^^^^^^^^^^^^^^^^^^^^^
  |   File "/nix/store/81sxy2crwqi6wx8bgils8s96j8sq8fy9-python3.12-packaging-24.2/lib/python3.12/site-packages/packaging/metadata.py", line 752, in from_raw
  |     raise ExceptionGroup("invalid metadata", exceptions)
  | ExceptionGroup: invalid metadata (1 sub-exception)
  +-+---------------- 1 ----------------
    | packaging.metadata.InvalidMetadata: license-file introduced in metadata version 2.4, not 2.1
    +------------------------------------
error: builder for '/nix/store/6s836yxxy0yfhblwbv2ini3hq12rdwjh-python3.12-setuptools-75.1.0.drv' failed with exit code 1;
       last 25 log lines:
       > adding 'setuptools/_vendor/zipp-3.19.2.dist-info/RECORD'
       > adding 'setuptools/_vendor/zipp-3.19.2.dist-info/REQUESTED'
       > adding 'setuptools/_vendor/zipp-3.19.2.dist-info/WHEEL'
       > adding 'setuptools/_vendor/zipp-3.19.2.dist-info/top_level.txt'
       > adding 'setuptools-75.1.0.post0.dist-info/RECORD'
       > removing build/bdist.linux-x86_64/wheel
       > Successfully built setuptools-75.1.0.post0-py3-none-any.whl
       > Finished creating a wheel...
       > Finished executing pypaBuildPhase
       > Running phase: pythonRuntimeDepsCheckHook
       > Executing pythonRuntimeDepsCheck
       > Checking runtime dependencies for setuptools-75.1.0.post0-py3-none-any.whl
       >   + Exception Group Traceback (most recent call last):
       >   |   File "/nix/store/gdxd1rn8zgjjw08ijghvpazj18n4sjl6-python-runtime-deps-check-hook.py", line 93, in <module>
       >   |     metadata = get_metadata(args.wheel)
       >   |                ^^^^^^^^^^^^^^^^^^^^^^^^
       >   |   File "/nix/store/gdxd1rn8zgjjw08ijghvpazj18n4sjl6-python-runtime-deps-check-hook.py", line 58, in get_metadata
       >   |     metadata = Metadata.from_raw(raw)
       >   |                ^^^^^^^^^^^^^^^^^^^^^^
       >   |   File "/nix/store/81sxy2crwqi6wx8bgils8s96j8sq8fy9-python3.12-packaging-24.2/lib/python3.12/site-packages/packaging/metadata.py", line 752, in from_raw
       >   |     raise ExceptionGroup("invalid metadata", exceptions)
       >   | ExceptionGroup: invalid metadata (1 sub-exception)
       >   +-+---------------- 1 ----------------
       >     | packaging.metadata.InvalidMetadata: license-file introduced in metadata version 2.4, not 2.1
       >     +------------------------------------
       For full logs, run 'nix log /nix/store/6s836yxxy0yfhblwbv2ini3hq12rdwjh-python3.12-setuptools-75.1.0.drv'.
error: 1 dependencies of derivation '/nix/store/c0p5sdxx59wjm7qc6hsm30366g2nb9nc-python3.12-certifi-2024.08.30.drv' failed to build
error: 1 dependencies of derivation '/nix/store/x4w33pq7dya671yan81x8ajfdxfwg7iw-python3.12-cffi-1.17.1.drv' failed to build
error: 1 dependencies of derivation '/nix/store/4wjrgfr5vzsc49kqj2v4ccbfgr7nfrr2-python3.12-pytest-8.3.3.drv' failed to build
error: 1 dependencies of derivation '/nix/store/gd4zr2v11kvnfnbnbifp7zf226yfqbl2-python3.12-pytest-mock-3.14.0.drv' failed to build
error: 1 dependencies of derivation '/nix/store/c1w027c4y11kcvfkinrv0qprpgvr8575-python3.12-setuptools-scm-8.1.0.drv' failed to build
error: 1 dependencies of derivation '/nix/store/i6d8naj0cbgwp7pc7i5hwar5s0lfckdv-setuptools-build-hook.drv' failed to build
error: 1 dependencies of derivation '/nix/store/6akq3b0pzs85wyfwdzc369qhnl79syf0-python3-3.12.7-env.drv' failed to build
```

## Installation

### uv tool install

The `uv tool install` command creates a private virtual environment for the
program you are installing. Unfortunately it doesn't also bundle in a Python
interpreter so it's still better to use `nix`.

```bash
$ devbox run uv tool install git+https://github.com/vpayno/pysay

$ which pysay
/home/vpayno/.local/bin/pysay

$ ls -lh /home/vpayno/.local/bin/pysay
lrwxrwxrwx 1 vpayno vpayno 50 Feb 17 22:37 /home/vpayno/.local/bin/pysay -> /home/vpayno/.local/share/uv/tools/pysay/bin/pysay

$ tree /home/vpayno/.local/share/uv/tools/pysay/
/home/vpayno/.local/share/uv/tools/pysay/
├── bin
│   ├── activate
│   ├── activate.bat
│   ├── activate.csh
│   ├── activate.fish
│   ├── activate.nu
│   ├── activate.ps1
│   ├── activate_this.py
│   ├── deactivate.bat
│   ├── markdown-it
│   ├── pydoc.bat
│   ├── pygmentize
│   ├── pysay
│   ├── python -> /home/vpayno/git_vpayno/pysay-cr-nix/.devbox/nix/profile/default/bin/python
│   ├── python3 -> python
│   └── python3.12 -> python
├── CACHEDIR.TAG
├── lib
│   └── python3.12
│       └── site-packages
│           ├── markdown_it
│           ├── markdown_it_py-3.0.0.dist-info
│           ├── mdurl
│           ├── mdurl-0.1.2.dist-info
│           ├── pygments
│           ├── pygments-2.19.1.dist-info
│           ├── pysay
│           │   ├── __init__.py
│           │   ├── __main__.py
│           │   ├── main.py
│           │   ├── snake.py
│           │   └── _version.py
│           ├── pysay-0.4.1.dev8+gba124be.dist-info
│           │   ├── direct_url.json
│           │   ├── entry_points.txt
│           │   ├── INSTALLER
│           │   ├── licenses
│           │   │   └── LICENSE
│           │   ├── METADATA
│           │   ├── RECORD
│           │   ├── REQUESTED
│           │   └── WHEEL
│           ├── rich
│           ├── rich-13.9.4.dist-info
│           ├── _virtualenv.pth
│           └── _virtualenv.py
├── lib64 -> lib
├── pyvenv.cfg
└── uv-receipt.toml

29 directories, 552 files
```

### nix profile

To install it use `nix profile install`:

```text
$ nix profile install github:vpayno/pysay?tag=v0.5.0

$ nix profile list
...
Name:               pysay
Flake attribute:    packages.x86_64-linux.default
Original flake URL: github:vpayno/pysay
Locked flake URL:   github:vpayno/pysay/79f80c9284550319b192ddae60f5c9fff76f6478?narHash=sha256-gbCb0mQyRSWkS8ctaSvvwWN7yvtJr/5jVljE7SVW/vU%3D
Store paths:        /nix/store/61i2bx85wzvpww6bjcgzwx1f2psvyznf-pysay-prod-env
...

$ which pysay
/home/vpayno/.nix-profile/bin/pysay
```

## Running UV Tools

`uv` doesn't support custom commands like `pdm` does so I'm using `poethepoet`
to define and run them.

To see a list of available commands run:

```text
devbox run uv run poe
```
